name: Publish GitHub Release and Backfill

on:
  push:
    branches:
      - master

jobs:
  publish_and_backfill:
    name: Publish GitHub release and create backfill PR
    runs-on: ubuntu-latest
    steps:
    
      - name: Checkout codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest draft release
        id: get_release
        run: |
          # Get the latest draft release
          RELEASE_DATA=$(gh release list --limit 1 --json isDraft,tagName,name | jq -r '.[0]')
          IS_DRAFT=$(echo "$RELEASE_DATA" | jq -r '.isDraft')
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tagName')
          
          echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Found release: ${TAG_NAME} (draft: ${IS_DRAFT})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish draft release
        if: steps.get_release.outputs.is_draft == 'true'
        run: |
          gh release edit ${{ steps.get_release.outputs.tag_name }} --draft=false --latest
          echo "Published release ${{ steps.get_release.outputs.tag_name }} as latest"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  backfill:
    name: Backfill master to develop branch
    runs-on: ubuntu-latest
    steps:
      - name: Check params
        run: |
          echo "head.ref = ${{github.event.pull_request.head.ref}}"
          echo "base.ref = ${{github.event.pull_request.base.ref}}"

      - uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ secrets.ACTIONS_NICHOLAS_PAT }}

      - name: Create backfill branch
        run: git checkout -b backfill/master;

      # In order to make a commit, we need to initialize a user.
      - name: Initialize mandatory git config
        run: |
          git config user.name "GitHub actions"
          git config user.email noreply@github.com

      - name: Push backfill branch
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_NICHOLAS_PAT }}
        run: |
          git push origin backfill/master

      - name: Create backfill pull request to develop branch
        uses: thomaseizinger/create-pull-request@1.4.0
        with:
          github_token: ${{ secrets.ACTIONS_NICHOLAS_PAT }}
          head: backfill/master
          base: develop
          draft: true
          title: Backfill ${{ github.event.pull_request.base.ref }} branch to develop branch
          body: |
            Hi @${{ github.actor }}!

            This PR was created in response to a trigger of the release workflow here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}.
            Following a release, this is a backfill from the main branch to the develop branch.
